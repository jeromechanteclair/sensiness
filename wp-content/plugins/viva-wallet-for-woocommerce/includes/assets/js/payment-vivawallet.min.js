jQuery(function(u){var l,o,n,i=!0,c=[],s=vivawallet_params.orderId,d=!1,p=1,h=1,m="",v=!1,U={message:null,overlayCSS:{background:"#fff",opacity:.6}};function f(e){u(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),F.prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout">'+e+"</div>"),F.removeClass("processing").unblock(),F.find(".input-text, select, input:checkbox").trigger("validate").blur(),_(),u(document.body).trigger("checkout_error")}function _(){v=!0;var e=u(".woocommerce-NoticeGroup-updateOrderReview, .woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message");(e=e.length?e:u("form.checkout")).length&&u("html, body").animate({scrollTop:e.offset().top-100},1e3)}function w(e,a){return vivawallet_params.ajax_url.toString().replace("%%endpoint%%",a+e)}var y=function(e){if(F.addClass("processing").block(U),W()&&!1===k())return f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForCCerror+"</li></ul>"),!1;var a="";if(!q())if(0<u("#billing_name").length)a=u("#billing_name").val().trim();else{if(!(0<u("#billing_first_name").length&&0<u("#billing_last_name").length))return f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForNameNULLerror+"</li></ul>"),!1;a=u("#billing_first_name").val().trim()+" "+u("#billing_last_name").val().trim()}if(n=u("#drpInstallments").val(),(isNaN(n)||n<=1||null===n)&&(n="1"),u('input[data-vp="cardholder"]').val(a),u('input[data-vp="accessToken"]').val(vivawallet_params.token),q()){if((a=u("input#terms")).length&&!a.is(":checked"))return f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForTermsError+"</li></ul>"),!1;u('input[data-vp="cardholder"]').val(vivawallet_params.orderCustomerName),(W()?r:g)()}else a=F.serialize(),a+="&nativeCheckoutForm=true",u.ajax({url:w("checkout",""),type:"POST",data:a,success:function(e){"success"===e.resultApi&&(s=e.orderId,vivawallet_params.checkoutSecurity=e.checkoutSecurity,vivawallet_params.cartTotalSecurity=e.cartTotalSecurity,vivawallet_params.returnUrl=e.returnUrl,d=e.saveCard,W()?t(r):t(g)),"failure"!==e.result&&"error"!==e.result||(!0===e.refresh&&(F.removeClass("processing").unblock(),u(document.body).trigger("update_checkout")),e.messages?f(e.messages):e.message&&f('<ul class="woocommerce-error" role="alert"><li>'+e.message+"</li></ul>"))},error:function(){f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForAJAXerror+"</li></ul>")}});return!1};function t(a){var e={security:vivawallet_params.cartTotalSecurity};u.ajax({type:"POST",data:e,url:w("get_cart_total_amount","wc_vivawallet_"),success:function(e){0!==e.length&&(vivawallet_params.amount=Number(e),null!==a&&a())}})}function r(){VivaPayments.cards.setup({authToken:vivawallet_params.token,baseURL:vivawallet_params.scriptUrl,cardHolderAuthOptions:{cardHolderAuthPlaceholderId:"VWpaymentContainer",cardHolderAuthInitiated:function(){u("#VWsecureModal").css({display:"flex"})},cardHolderAuthFinished:function(){u("#VWsecureModal").hide()}}}),VivaPayments.cards.requestToken({amount:100*Number(vivawallet_params.amount),installments:n}).done(function(e){l=e.chargeToken,g()}).fail(function(e){console.log("Here is the reason it failed: "+e.Error.toString()),console.dir(e)})}function g(){e=u('input[data-vp="cardnumber"]').val(),a=(e=e.replace(/ /g,"")).substring(e.length-4),r=(t=u.payment.cardExpiryVal(u('input[data-vp="expdate"]').val())).month,t=t.year,a={url:w("process_payment","wc_vivawallet_"),security:vivawallet_params.checkoutSecurity,accessToken:vivawallet_params.token,chargeToken:l,cardNumberLast4:a,expiryMonth:r,expiryYear:t,cardType:u.payment.cardType(e),installments:n,savePaymentMethod:d,orderId:s,returnUrl:vivawallet_params.returnUrl,isUserLoggedIn:vivawallet_params.isUserLoggedIn},L()&&(a.paymentMethodId="10"),S()&&(a.paymentMethodId="11"),N()&&(a.paymentMethodId="13"),M()&&(a.paymentMethodId="14"),A()&&(a.paymentMethodId="15"),j()&&(a.paymentMethodId="16"),H()&&(a.paymentMethodId="17"),E()&&(a.paymentMethodId="18"),G()&&(a.paymentMethodId="19"),!q()||!1===P()&&!1!==O()||(a.relatedSubscription=P(),a.url=w("add_payment_method","wc_vivawallet_"),a.security=vivawallet_params.add_payment_method_nonce,a.installments="1",u("#update_all_subscriptions_payment_method").is(":checked")&&(a.updateAllSubscriptionsPayment=!0));var e,a,t,r=a;u.ajax({url:r.url,type:"POST",data:r,success:function(e){"success"===e.result&&e.redirect&&(window.location.href=e.redirect),"failure"===e.result&&(F.removeClass("processing").unblock(),!0===e.reload?window.location.reload():f('<ul class="woocommerce-error" role="alert"><li>'+e.messages+"</li></ul>"))},error:function(){f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForAJAXerror+"</li></ul>")}})}var b=function(e){var a=u("#vivawallet_native-card-number"),t=u("#vivawallet_native-card-expiry"),r=u("#vivawallet_native-card-cvc"),l=a.val(),a=(l.length&&a.attr("value",l),t.val()),t=(a.length&&t.attr("value",a),r.val());t.length&&r.attr("value",t),k(),void 0!==e.target&&"vivawallet_native-card-number"!==e.target.id||(l=l.replace(/ /g,""),o&&m!==l&&(m=l,u.ajax({type:"GET",beforeSend:function(e){e.setRequestHeader("CardNumber",m),e.setRequestHeader("Authorization","Bearer "+vivawallet_params.token),e.setRequestHeader("Content-Type","application/json")},url:vivawallet_params.installmentsUrl,success:function(e){i=!0===e.requiresCvv?(u("#vivawallet_native-card-cvc").show(),u("#wc-vivawallet_native-cc-form label[for=vivawallet_native-card-cvc]").show(),!0):(u("#vivawallet_native-card-cvc").hide(),u("#vivawallet_native-card-cvc").val(""),u("#wc-vivawallet_native-cc-form label[for=vivawallet_native-card-cvc]").hide(),!1),p=e.maxInstallments,q()||I(),!1===P()&&!0===O()&&I()},error:function(e){console.error("Connection to Viva Wallet API Failed"),console.log(JSON.stringify(e)),f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForAPIerror+"</li></ul>")}})))};function k(){var e=u("#vivawallet_native-card-number"),a=u("#vivawallet_native-card-expiry"),t=u("#vivawallet_native-card-cvc"),r=(e.parent().removeClass("woocommerce-invalid woocommerce-invalid-required-field"),a.parent().removeClass("woocommerce-invalid woocommerce-invalid-required-field"),t.parent().removeClass("woocommerce-invalid woocommerce-invalid-required-field"),u('input[data-vp="cardnumber"]').val()),l=!0,e=((o=u.payment.validateCardNumber(r))||(e.parent().addClass("woocommerce-invalid woocommerce-invalid-required-field"),l=!1),u('input[data-vp="expdate"]').val()),e=u.payment.cardExpiryVal(e);return u.payment.validateCardExpiry(e.month.toString(),e.year.toString())||(a.parent().addClass("woocommerce-invalid woocommerce-invalid-required-field"),l=!1),i&&!u.payment.validateCardCVC(u('input[data-vp="cvv"]').val(),u.payment.cardType(r))&&(t.parent().addClass("woocommerce-invalid woocommerce-invalid-required-field"),l=!1),l}function C(e){if(void 0===u.payment)console.warn("VivaPayments: jquery.payments.js is required but not found on page load. Please  update your WooCommerce plugin.");else{for(var a=u.payment.cards.length,t=e.length,r=a;0<r;r--)u.payment.cards.splice(r-1,1);for(var l=0;l<t;l++){for(var o=[],n=e[l].patterns.length,i=0;i<n;i++)if(Array.isArray(e[l].patterns[i]))for(var c=e[l].patterns[i][0];c<=e[l].patterns[i][1];c++)o.push(c);else o.push(e[l].patterns[i]);e[l].patterns=o,u.payment.cards.push(e[l])}}}function I(){var e=vivawallet_params.installmentsLogic,a=vivawallet_params.allowInstallments,t=vivawallet_params.amount,r=1;if("1"===a&&1<p){if("string"==typeof e&&""!==e){for(var l=e.split(","),o=l.length,n=[],i=0;i<o;i++){var c=l[i].split(":"),s=c[0],c=c[1];Number(t)>=Number(s)&&n.push(c)}0<n.length&&(r=Math.max.apply({},n))}if(1<(r=p<r?p:r)){if(h!==r){var d=r;u("#drpInstallments").empty(),u("#VWinstallments").show();for(var m=1;m<=d;m++){var v=m;1===v&&(v="0"),m<=d&&u("#drpInstallments").append(u("<option>").val(m).text(v))}h=r}}else V(),h=1}else V(),h=1}function V(){u("#VWinstallments").hide(),u("#drpInstallments").empty()}function x(){t(I)}function W(){return u("#payment_method_vivawallet_native").is(":checked")}function T(){return L()||S()||N()||M()||A()||j()||H()||E()||G()}function L(){return u("#payment_method_vivawallet-ideal").is(":checked")}function S(){return u("#payment_method_vivawallet-p24").is(":checked")}function N(){return u("#payment_method_vivawallet-payu").is(":checked")}function M(){return u("#payment_method_vivawallet-multibanco").is(":checked")}function A(){return u("#payment_method_vivawallet-giropay").is(":checked")}function j(){return u("#payment_method_vivawallet-directpay").is(":checked")}function H(){return u("#payment_method_vivawallet-eps").is(":checked")}function E(){return u("#payment_method_vivawallet-wechatpay").is(":checked")}function G(){return u("#payment_method_vivawallet-bitpay").is(":checked")}function q(){return!(!u("form#add_payment_method").length&&!u("form#order_review").length)}var e=window.location.search;const a=new URLSearchParams(e);function O(){return"true"===a.get("pay_for_order")}function P(){var e=a.get("change_payment_method");return null!==e&&e}function R(e=null){if(void 0===e.target||"payment_method_vivawallet_native"!==e.target.id||!W()&&!T()||q()||x(),W()||T()){if(0!==u(".woocommerce-error").length&&!1===v&&(_(),v=!0),u(document.body).off("updated_checkout",x),u(document.body).on("updated_checkout",x),F.off("checkout_place_order",y),F.on("checkout_place_order",y),F.off("blur change keydown focusout",b),F.on("blur change keydown focusout",b),0!==u("form#add_payment_method").length&&(u("form#add_payment_method").off("submit",y),u("form#add_payment_method").on("submit",y)),0!==u("form#order_review").length&&(u("form#order_review").off("submit",y),u("form#order_review").on("submit",y)),0===c.length)for(var a=u.payment.cards.length,t=0;t<a;t++)c.push(u.payment.cards[t]);var r;C(J),0===u("#VWinstallments").length&&(r='<p class="form-row form-row-wide" id="VWinstallments">',r=(r+='<label for="drpInstallments">')+vivawallet_params.labelForInstallments+' <span class="required">*</span><select id="drpInstallments" name="drpInstallments"></select></label></p>',u("#wc-vivawallet_native-cc-form").append(r)),0===u("#VWhiddenFields").length&&(r='<div id="VWhiddenFields" style="clear: both">',r+='<input type="hidden" data-vp="cardholder" placeholder="cardholder name" /><input type="hidden" data-vp="accessToken" placeholder="card access token" autocomplete="off"/></div>',u("#wc-vivawallet_native-cc-form").append(r)),vivawallet_params.showVWLogo&&0===u("#VWlogoContainer").length&&(r='<div class="VWLogoContainer" style="clear: both" id="VWlogoContainer">',r=(r=(r+="<p>")+vivawallet_params.labelLogoTxt)+'<a href="https://www.vivawallet.com/" target="_blank"><img src="'+vivawallet_params.logoPath+'"></a></p></div>',u("#wc-vivawallet_native-cc-form").append(r)),0===u("#VWsecureModal").length&&(r='<div id="VWsecureModal">',r+='<div id="VWpaymentContainer"></div></div>',u("body").append(r))}else u(document.body).off("updated_checkout",x),F.off("checkout_place_order",y),F.off("blur change focusout",b),0!==u("form#add_payment_method").length&&u("form#add_payment_method").off("submit",y),0!==u("form#order_review").length&&u("form#order_review").off("submit",y),C(c),(e=u("#wc-vivawallet_native-cc-form")).find("#VWinstallments").remove(),e.find("#VWhiddenFields").remove(),e.find("#VWlogoContainer").remove(),e.find("#VWsecureModal").remove(),h=1}e=/(\d{1,4})/g;let J=[{type:"bancontact",patterns:[479658,48107907,487104,487109,51278800,516920,518272,522122,522962,525565,539442,[56135900,56135902],56136100,56140700,606005,6703],format:e,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"jcb",patterns:[2131,1800,[3528,3589]],format:e,length:[16,17,18,19],cvcLength:[3],luhn:!0},{type:"mastercard",patterns:[[51,55],[2221,2229],[223,229],[23,26],[270,271],2720],format:e,length:[16],cvcLength:[3],luhn:!0},{type:"amex",patterns:[34,37],format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,length:[15],cvcLength:[4],luhn:!0},{type:"dinersclub",patterns:[[300,305],36,38,39],format:/(\d{1,4})(\d{1,6})?(\d{1,4})?/,length:[14,16,19],cvcLength:[3],luhn:!0},{type:"discover",patterns:[6011,[644,649],65],format:e,length:[16,19],cvcLength:[3],luhn:!0},{type:"visa",patterns:[4],format:e,length:[16,18,19],cvcLength:[3],luhn:!0},{type:"maestro",patterns:[[5e5,506698],[506779,508999],[56,59],63,67,6],format:e,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"default",patterns:[0,1,2,3,4,5,6,7,8,9],format:e,length:[12,13,14,15,16,17,18,19],cvcLength:[3,4],luhn:!0}];var F=u("form.woocommerce-checkout");u("form#add_payment_method").length&&(F=u("form#add_payment_method")),u("form#order_review").length&&(F=u("form#order_review")),u(R),u("#vivawallet_native-card-cvc").attr("autocomplete","cc-csc"),F.on("change",function(e){R(e)})});