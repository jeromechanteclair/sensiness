jQuery(function(i){"use strict";var p,o,s,t=null,l=!1;function a(e){var t,a,n;vivawallet_apple_pay_params.is_product||(t=["name","phone","email"],!0===e.shipping_required&&(l=!0,t=["postalAddress","name","phone","email"]),a=[],e.order_data.lineItems.forEach(function(e){e={label:e.label,type:"final",amount:e.amount};a.push(e)}),t={total:e.order_data.total,lineItems:a,countryCode:e.order_data.country_code,currencyCode:e.order_data.currency,merchantCapabilities:["supports3DS"],supportedNetworks:["amex","masterCard","visa"],requiredBillingContactFields:["postalAddress","name","phone","email"],requiredShippingContactFields:t},e.order_data),n=t,i("#apple-pay-button").on("click",function(e){e.preventDefault(),(p=new window.ApplePaySession(6,n)).onvalidatemerchant=function(e){e={providerId:"applepay",sourceCode:vivawallet_apple_pay_params.sourceCode,validationUrl:e.validationURL};i.ajax({data:JSON.stringify(e),type:"POST",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+vivawallet_apple_pay_params.token),e.setRequestHeader("Content-Type","application/json")},url:vivawallet_apple_pay_params.applePayTokenUrl,success:function(e){p.completeMerchantValidation(JSON.parse(e.chargeToken))},error:function(e){alert("Connection to VivaWallet API failed. Please try again later."),console.log(e)}})},p.onshippingcontactselected=function(e){i.when((e=e,e={security:vivawallet_apple_pay_params.security.shipping,country:e.shippingContact.countryCode.toUpperCase(),state:e.shippingContact.country,postcode:e.shippingContact.postalCode,city:"",is_product:vivawallet_apple_pay_params.is_product},i.ajax({type:"POST",data:e,url:r("get_shipping_data")}))).then(function(e){var t;"shipping_address_not_valid"===e.result&&(t={errors:[new window.ApplePayError("shippingContactInvalid","postalAddress")],newTotal:e.total,newLineItems:e.lineItems,newShippingMethods:[]}),"success"===e.result&&(t={newTotal:e.total,newLineItems:e.lineItems,newShippingMethods:e.shipping_methods}),p.completeShippingContactSelection(t)})},p.onshippingmethodselected=function(e){var t;i.when((s=(t=e).shippingMethod.identifier,t={security:vivawallet_apple_pay_params.security.update_shipping,shipping_method:[e.shippingMethod.identifier],payment_request_type:"apple_pay",is_product:vivawallet_apple_pay_params.is_product},i.ajax({type:"POST",data:t,url:r("update_shipping_data")}))).then(function(e){var t;"success"===e.result&&(t={newTotal:e.total,newLineItems:e.lineItems}),"fail"===e.result&&(t={errors:[new window.ApplePayError("shippingContactInvalid","postalAddress")],newTotal:e.total,newLineItems:e.lineItems}),p.completeShippingMethodSelection(t)})},p.onpaymentauthorized=function(e){var t=e.payment.token,t=(o=JSON.stringify(t),n);t=function(e,t){e={_wpnonce:vivawallet_apple_pay_params.security.checkout,billing_first_name:t.payment.billingContact.givenName,billing_last_name:t.payment.billingContact.familyName,billing_company:"",billing_email:t.payment.shippingContact.emailAddress,billing_phone:t.payment.shippingContact.phoneNumber,billing_country:t.payment.billingContact.countryCode.toUpperCase(),billing_address_1:void 0!==t.payment.billingContact.addressLines[0]?t.payment.billingContact.addressLines[0]:"",billing_address_2:void 0!==t.payment.billingContact.addressLines[1]?t.payment.billingContact.addressLines[1]:"",billing_city:void 0!==t.payment.billingContact.locality?t.payment.billingContact.locality:"",billing_state:void 0!==t.payment.billingContact.country?t.payment.billingContact.country:"",billing_postcode:t.payment.billingContact.postalCode,shipping_first_name:"",shipping_last_name:"",shipping_company:"",shipping_country:"",shipping_address_1:"",shipping_address_2:"",shipping_city:"",shipping_state:"",shipping_postcode:"",shipping_method:[s],order_comments:"",payment_method:"vivawallet_native",payment_request_type:"apple_pay",ship_to_different_address:1,terms:1,applePayAccessToken:vivawallet_apple_pay_params.token,applePayChargeToken:o};l&&(e.shipping_first_name=t.payment.shippingContact.givenName,e.shipping_last_name=t.payment.shippingContact.familyName,e.shipping_company="",e.shipping_country=t.payment.shippingContact.countryCode.toUpperCase(),e.shipping_address_1=void 0!==t.payment.shippingContact.addressLines[0]?t.payment.shippingContact.addressLines[0]:"",e.shipping_address_2=void 0!==t.payment.shippingContact.addressLines[1]?t.payment.shippingContact.addressLines[1]:"",e.shipping_city=void 0!==t.payment.shippingContact.locality?t.payment.shippingContact.locality:"",e.shipping_state=void 0!==t.payment.shippingContact.country?t.payment.shippingContact.country:"",e.shipping_postcode=t.payment.shippingContact.postalCode);return e}(t,e),i.ajax({type:"POST",data:t,dataType:"json",url:r("create_order"),success:function(e){var t,a;"success"===e.result?(t={status:window.ApplePaySession.STATUS_SUCCESS,errors:[]},p.completePayment(t),window.location=e.redirect):(t=e.messages,p.abort(),i(".woocommerce-error").remove(),vivawallet_apple_pay_params.is_product?((a=i(".product")).before(t),i("html, body").animate({scrollTop:a.prev(".woocommerce-error").offset().top},600)):((a=i(".shop_table.cart").closest("form")).before(t),i("html, body").animate({scrollTop:a.prev(".woocommerce-error").offset().top},600)))}})},p.begin()})}function r(e){return vivawallet_apple_pay_params.ajax_url.toString().replace("%%endpoint%%","wc_vivawallet_"+e)}function n(){i("#VWapplePayBut").show()}function c(){i("#VWapplePayBut").hide()}function e(){var e;null===t?-1===window.location.href.indexOf("https")?(c(),t=!1,console.warn("VivaWallet: Your website does not appear to be using a secure connection. Apple pay must be served over https.")):window.ApplePaySession?!0===window.ApplePaySession.canMakePayments()?(n(),t=!0):window.ApplePaySession.canMakePaymentsWithActiveCard().then(function(e){t=!0===e?(n(),!0):(c(),!1)}):(c(),t=!1,console.warn("VivaWallet: This device and/or browser does not support Apple Pay.")):(!0===t?n:c)(),vivawallet_apple_pay_params.is_product?a(""):(e={security:vivawallet_apple_pay_params.security.payment},i.ajax({type:"POST",data:e,url:r("get_cart_data"),success:function(e){a(e)}}))}i(e),i(document.body).on("updated_cart_totals",function(){e()}),i(document.body).on("updated_checkout",function(){e()})});